#!/bin/bash

subj_id=SUBJECTID
ses_id=SESID
s3_precomputed_path=S3PRECOMPUTEDPATH
s3_bids_path=S3BIDSPATH
s3_upload_path=S3UPLOADPATH
nibabies_dir=NIBABIESDIR
precomputed_dir=PRECOMPUTEDDIR
xcpd_dir=XCPDDIR
run_dir=RUNDIR
singularity=`which singularity`
recon_method=RECONMETHOD
bsmin=BSMIN
bsmax=BSMAX
skip_nibabies=SKIPNIBABIES
skip_xcpd=SKIPXCPD
nibabies_clean_workdir=NIBABIESCLEAN
xcpd_clean_workdir=XCPDCLEAN
precomputed_derivatives_string=""
surface_recon_method_string=""
nibabiesclean_string=""
xcpdclean_string=""
motion_filter_string=""


module load matlab/R2019a

if [[ "$nibabies_clean_workdir" = true ]] ; then
  nibabiesclean_string="--clean-workdir"
fi

if [[ "$xcpd_clean_workdir" = true ]] ; then
  xcpdclean_string="--clean-workdir"
fi

if [[ ! -z "$recon_method" ]] ; then
  surface_recon_method_string="--surface-recon-method $recon_method"
fi

if [[ ! -z "$bsmin" ]] ; then
  motion_filter_string="--motion-filter-type notch --band-stop-min $bsmin --band-stop-max $bsmax"
fi




# pull down needed data and files from BIDS bucket
if [ ! -d ${nibabies_dir}/bids_dir/sub-${subj_id}_ses-${ses_id}/sub-${subj_id}/ses-${ses_id} ]; then
	mkdir -p ${nibabies_dir}/bids_dir/sub-${subj_id}_ses-${ses_id}/sub-${subj_id}
	s3cmd get ${s3_bids_path}/sub-${subj_id}/ses-${ses_id} ${nibabies_dir}/bids_dir/sub-${subj_id}_ses-${ses_id}/sub-${subj_id} --recursive -v
fi

if [[ ! -z "$s3_precomputed_path" ]] ; then
    if [ ! -d ${nibabies_dir}/precomputed_dir/sub-${subj_id}_ses-${ses_id}/sub-${subj_id}/ses-${ses_id} ]; then
            mkdir -p ${nibabies_dir}/precomputed_dir/sub-${subj_id}_ses-${ses_id}/sub-${subj_id}
    fi
    s3cmd get ${s3_precomputed_path}/sub-${subj_id}/ ${nibabies_dir}/precomputed_dir/sub-${subj_id}_ses-${ses_id} --recursive -v
    s3cmd get ${s3_precomputed_path}/dataset_description.json ${nibabies_dir}/precomputed_dir/sub-${subj_id}_ses-${ses_id} 
    precomputed_derivatives_string="--derivatives ${nibabies_dir}/precomputed_dir/sub-${subj_id}_ses-${ses_id}" 
fi
if [ ! -e ${nibabies_dir}/bids_dir/sub-${subj_id}_ses-${ses_id}/dataset_description.json ]; then
    cp ${run_dir}/dataset_description.json ${nibabies_dir}/bids_dir/sub-${subj_id}_ses-${ses_id}
fi
if [ ! -e ${nibabies_dir}/bids_dir/sub-${subj_id}_ses-${ses_id}/participants.tsv ]; then
    s3cmd get ${s3_bids_path}/participants.tsv ${nibabies_dir}/bids_dir/sub-${subj_id}_ses-${ses_id} -v 
fi


# create nibabies and xcp-d scratch output and workdirs

if [ ! -d ${nibabies_dir}/processed/nibabies/sub-${subj_id}_ses-${ses_id} ]; then
    mkdir -p ${nibabies_dir}/processed/nibabies/sub-${subj_id}_ses-${ses_id}
fi

if [ ! -d ${nibabies_dir}/work_dir/nibabies/sub-${subj_id}_ses-${ses_id} ]; then
    mkdir -p ${nibabies_dir}/work_dir/nibabies/sub-${subj_id}_ses-${ses_id}
fi

if [ ! -d ${xcpd_dir}/processed/sub-${subj_id}_ses-${ses_id} ]; then
    mkdir -p ${xcpd_dir}/processed/sub-${subj_id}_ses-${ses_id}
fi

if [ ! -d ${xcpd_dir}/work_dir/sub-${subj_id}_ses-${ses_id} ]; then
    mkdir -p ${xcpd_dir}/work_dir/sub-${subj_id}_ses-${ses_id}
fi


# run nibabies
if [[ ! "$skip_nibabies" = true ]] ; then
  singularity run --cleanenv \
  -B ${nibabies_dir}/bids_dir/sub-${subj_id}_ses-${ses_id}:/bids_dir \
  -B ${nibabies_dir}/processed/nibabies/sub-${subj_id}_ses-${ses_id}:/output_dir \
  -B ${nibabies_dir}/work_dir/nibabies/sub-${subj_id}_ses-${ses_id}:/wd \
  -B ${run_dir}/license.txt:/opt/freesurfer/license.txt \
  -B ${run_dir}/license.txt:/license.txt \
  /home/faird/shared/code/external/pipelines/nibabies/nibabies_t1-t2-derivatives_08282023a.sif \
  --output-spaces MNI152NLin6Asym:res-2 \
  --fs-license-file /license.txt \
  --resource-monitor \
  --project-goodvoxels \
  --omp-nthreads 3 \
  --cifti-output 91k \
  ${surface_recon_method_string} \
  ${nibabiesclean_string} \
  ${precomputed_derivatives_string} \
  -vv \
  -w /wd \
  /bids_dir /output_dir participant
fi

# run xcp-d
if [[ ! "$skip_xcpd" = true ]] ; then
  if [[ ! "$recon_method" = "mcribs" ]] ; then
	  singularity run --cleanenv \
	  -B /home/faird/shared/code/external/utilities/freesurfer_license/license.txt:/opt/freesurfer/license.txt \
	  -B ${nibabies_dir}/processed/nibabies/sub-${subj_id}_ses-${ses_id}:/nibabies_out \
	  -B ${xcpd_dir}/processed/sub-${subj_id}_ses-${ses_id}:/xcpd_out \
	  -B ${xcpd_dir}/work_dir/sub-${subj_id}_ses-${ses_id}:/wkdir \
	   /home/faird/shared/code/external/pipelines/xcp_d/xcp_d_0.5.0rc2.sif \
	  -f 0.3 \
	  --cifti \
	  -m \
	  --participant-label ${subj_id} \
	  --resource-monitor \
	  --dcan-qc \
	  --omp-nthreads 3 \
	  --despike \
	  --lower-bpf 0.009 \
	  ${motion_filter_string} \
	  ${xcpdclean_string} \
	  --warp-surfaces-native2std \
	  -vv \
	  --input-type nibabies \
	  -w /wkdir \
	  /nibabies_out /xcpd_out participant
  else
	  singularity run --cleanenv \
	  -B /home/faird/shared/code/external/pipelines/xcp_d_test_binds/PR924/xcp_d/xcp_d/tests/test_utils_bids.py:/usr/local/miniconda/lib/python3.8/site-packages/xcp_d/tests/test_utils_bids.py \
	  -B /home/faird/shared/code/external/pipelines/xcp_d_test_binds/PR924/xcp_d/xcp_d/utils/bids.py:/usr/local/miniconda/lib/python3.8/site-packages/xcp_d/utils/bids.py \
	  -B /home/faird/shared/code/external/pipelines/nibabies_test_binds/atlases/dHCP/dHCP.week42.L.sphere.surf.gii:${HOME}/.cache/templateflow/tpl-fsLR/tpl-fsLR_hemi-L_den-32k_sphere.surf.gii:ro \
	  -B /home/faird/shared/code/external/pipelines/nibabies_test_binds/atlases/dHCP/dHCP.week42.R.sphere.surf.gii:${HOME}/.cache/templateflow/tpl-fsLR/tpl-fsLR_hemi-R_den-32k_sphere.surf.gii:ro \
	  -B /home/faird/shared/code/external/pipelines/nibabies_test_binds/atlases/mcribs/lh.sphere.reg2.surf.gii:${HOME}/.cache/templateflow/tpl-fsaverage/tpl-fsaverage_hemi-L_den-164k_sphere.surf.gii:ro \
	  -B /home/faird/shared/code/external/pipelines/nibabies_test_binds/atlases/mcribs/rh.sphere.reg2.surf.gii:${HOME}/.cache/templateflow/tpl-fsaverage/tpl-fsaverage_hemi-R_den-164k_sphere.surf.gii:ro \
	  -B /home/faird/shared/code/external/pipelines/nibabies_test_binds/atlases/mcribs/lh.sphere.reg.dHCP42.surf.gii:/usr/local/miniconda/lib/python3.8/site-packages/xcp_d/data/standard_mesh_atlases/fs_L/fs_L-to-fs_LR_fsaverage.L_LR.spherical_std.164k_fs_L.surf.gii:ro \
	  -B /home/faird/shared/code/external/pipelines/nibabies_test_binds/atlases/mcribs/rh.sphere.reg.dHCP42.surf.gii:/usr/local/miniconda/lib/python3.8/site-packages/xcp_d/data/standard_mesh_atlases/fs_R/fs_R-to-fs_LR_fsaverage.R_LR.spherical_std.164k_fs_R.surf.gii:ro \
	  -B /home/faird/shared/code/external/utilities/freesurfer_license/license.txt:/opt/freesurfer/license.txt \
	  -B ${nibabies_dir}/processed/nibabies/sub-${subj_id}_ses-${ses_id}:/nibabies_out \
	  -B ${xcpd_dir}/processed/sub-${subj_id}_ses-${ses_id}:/xcpd_out \
	  -B ${xcpd_dir}/work_dir/sub-${subj_id}_ses-${ses_id}:/wkdir \
	   /home/faird/shared/code/external/pipelines/xcp_d/xcp_d_0.5.0rc2.sif \
	  -f 0.3 \
	  --cifti \
	  -m \
	  --participant-label ${subj_id} \
	  --resource-monitor \
	  --dcan-qc \
	  --omp-nthreads 3 \
	  --despike \
	  --lower-bpf 0.009 \
	  ${motion_filter_string} \
	  ${xcpdclean_string} \
	  --warp-surfaces-native2std \
	  -vv \
	  --input-type nibabies \
	  -w /wkdir \
	  /nibabies_out /xcpd_out participant
  fi

   
fi

# (temporary until xcp_d includes sulc/curv/thickness derivatives -- sync them from nibabies anat dir instead)
rsync -urlHSE ${nibabies_dir}/processed/nibabies/sub-${subj_id}_ses-${ses_id}/sub-${subj_id}/ses-${ses_id}/anat/*.dscalar.nii ${xcpd_dir}/processed/sub-${subj_id}_ses-${ses_id}/xcp_d/sub-${subj_id}/ses-${ses_id}/anat

# convert hdf5 motion data files to DCAN format
/home/faird/shared/code/internal/utilities/xcpd2dcanmotion/run_xcpd2dcanmotion_on_func_dir.sh ${xcpd_dir}/processed/sub-${subj_id}_ses-${ses_id}/xcp_d/sub-${subj_id}/ses-${ses_id}/func

#push processed outputs to bucket
s3cmd sync -F --recursive -v --delete-removed ${nibabies_dir}/processed/nibabies/sub-${subj_id}_ses-${ses_id}/sub-${subj_id}/ ${s3_upload_path}/nibabies/sub-${subj_id}/ses-${ses_id}/
s3cmd sync -F --recursive -v --delete-removed ${xcpd_dir}/processed/sub-${subj_id}_ses-${ses_id}/ ${s3_upload_path}/xcpd/sub-${subj_id}_ses-${ses_id}/
