#!/bin/bash

subject_id=SUBJECTID
subject_dir=SUBJECTDIR
singularity=`which singularity`
output_dir=/tmp/dicom2bids/SUBJECTID
work_dir=/tmp/dicom2bids/SUBJECTID/work
download_dir=/tmp/dicom2bids/SUBJECTID/download
data_bucket=s3://bucket_name
ses_id=2_year_follow_up_y_arm_1

source /home/faird/shared/code/external/envs/miniconda3/load_miniconda3.sh

module load singularity

. "/home/faird/shared/code/external/envs/miniconda3/mini3/etc/profile.d/conda.sh"
export PATH="/home/faird/shared/code/external/envs/miniconda3/mini3/bin:$PATH"
export PATH=$PATH:/home/feczk001/shared/code/external/utilities/dcmtk-3.6.5/dcmtk-3.6.5-build/bin
export PATH=$PATH:/home/feczk001/shared/code/external/utilities/jq-1.5

conda activate abcd-dicom2bids

python3 /home/rando149/shared/code/internal/utilities/abcd-dicom2bids/abcd2bids.py /common/software/install/migrated/fsl/6.0.4/ /home/feczk001/shared/code/external/utilities/MATLAB_MCR/v91/ -q /home/rando149/shared/code/internal/utilities/abcd-dicom2bids/spreadsheets/fastqc20230912/abcd_fastqc01.txt -l ${subject_dir}/${subject_id}.txt -o ${output_dir} -p 1221144 --download=${download_dir} --downloadcmd /home/faird/shared/code/external/envs/miniconda3/mini3/envs/abcd-dicom2bids/bin/downloadcmd --singularity /home/rando149/shared/code/internal/utilities/abcd-dicom2bids_nda/validator_latest.sif -y ${ses_id} --temp=${work_dir}

#sync EventRelatedInformation
if [ -d "${output_dir}/sourcedata/${subject_id}/" ] && [ ! -f withERI.txt ] ; then
	touch withERI.txt
	echo ${subject_id} >> withERI.txt
	
	s3cmd sync -F --recursive -v ${output_dir}/sourcedata/${subject_id} ${data_bucket}/sourcedata/ --delete-removed
	
elif [ -d "${output_dir}/sourcedata/${subject_id}/" ] && [ -f withERI.txt ] ; then
	echo ${subject_id} >> withERI.txt
	
	s3cmd sync -F --recursive -v ${output_dir}/sourcedata/${subject_id} ${data_bucket}/sourcedata/ --delete-removed
	
elif [ ! "${output_dir}/sourcedata/${subject_id}/" ] && [ ! -f withoutERI.txt ]; then
	touch withoutERI.txt
	echo ${subject_id} >> withoutERI.txt
else 
	echo ${subject_id} >> withoutERI.txt	
fi


#sync at subject dir
s3cmd sync -F --recursive -v ${output_dir}/${subject_id}/ ${data_bucket}/${subject_id}/ --delete-removed
