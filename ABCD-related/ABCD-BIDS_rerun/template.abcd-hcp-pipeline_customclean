#!/bin/bash 

subject_id=SUBJECTID
ses_id=SESID
data_dir=DATADIR
data_bucket=BUCKET
run_dir=RUNDIR
cpu_usage=8
singularity=`which singularity`


# pull down needed data and files from BIDS bucket
if [ ! -d ${data_dir}/sub-${subject_id}/ses-${ses_id} ]; then
	mkdir -p ${data_dir}/sub-${subject_id}
	s3cmd get ${data_bucket}/sub-${subject_id}/ses-${ses_id} ${data_dir}/sub-${subject_id} --recursive -v
fi

if [ ! -e ${data_dir}/dataset_description.json ]; then
	cp ${run_dir}/dataset_description.json ${data_dir}
fi

if [ -d ${data_dir}/derivatives/abcd-hcp-pipeline ]; then
    rm -rf ${data_dir}/derivatives/abcd-hcp-pipeline-v0.1.3
else
    mkdir -p ${data_dir}/derivatives/abcd-hcp-pipeline-v0.1.3
fi

if [ -d ${data_dir}/processed/abcd-hcp-pipeline ]; then
    rm -rf ${data_dir}/processed/abcd-hcp-pipeline
else
    mkdir -p ${data_dir}/processed/abcd-hcp-pipeline
fi

# run abcd-hcp-pipeline
env -i ${singularity} run --cleanenv --no-home \
-B ${data_dir}:/bids_dir \
-B ${data_dir}/processed/abcd-hcp-pipeline:/output_dir \
-B ${run_dir}/license.txt:/opt/freesurfer/license.txt \
-B ${run_dir}/ABCD_BIDS_cleaning.json:/ABCD_BIDS_cleaning.json \
/home/rando149/shared/code/internal/singularity_images/abcd-hcp-pipeline_v0.1.3.sif \
/bids_dir /output_dir \
--freesurfer-license /opt/freesurfer/license.txt \
--participant-label ${subject_id} \
--custom-clean /ABCD_BIDS_cleaning.json \
--ncpus ${cpu_usage}

# run file-mapper
/home/faird/shared/code/internal/utilities/file-mapper/file_mapper_script.py ${run_dir}/UKB-filemapper_abcd-hcp-pipeline-v0.1.3.json -a copy -sp  ${data_dir}  -dp ${data_dir}/derivatives/abcd-hcp-pipeline-v0.1.3/ -vb -o -t SUBJECT=${subject_id},SESSION=${ses_id},PIPELINE=abcd-hcp-pipeline-v0.1.3

# syncing all files from the derivatives mapped by file-mapper and push derivative outputs to bucket
s3cmd sync -F --recursive -v --delete-removed ${data_dir}/derivatives/abcd-hcp-pipeline-v0.1.3/sub-${subject_id}/ses-${ses_id}/ ${data_bucket}/derivatives/abcd-hcp-pipeline-v0.1.3/sub-${subject_id}/ses-${ses_id}/

# syncing all files in processed
s3cmd sync -F --recursive -v --delete-removed ${data_dir}/processed/abcd-hcp-pipeline-v0.1.3/sub-${subject_id}/ses-${ses_id}/ ${data_bucket}/processed/abcd-hcp-pipeline-v0.1.3/sub-${subject_id}/ses-${ses_id}/

